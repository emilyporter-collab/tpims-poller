name: TPIMS Poller

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch: {}     # Manual trigger

jobs:
  poll:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Write GCP credentials
        run: echo '${{ secrets.GCP_CREDENTIALS }}' > /tmp/gcp-creds.json
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

      - name: Poll TPIMS and insert to BigQuery
        run: python poller.py
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-creds.json

      - name: Auth failure notice
        if: failure()
        run: |
          echo "::error::TPIMS poller failed. If this is an auth error, re-run: gcloud auth application-default login, then update the GCP_CREDENTIALS secret at https://github.com/emilyporter-collab/tpims-poller/settings/secrets/actions"
